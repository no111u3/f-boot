/** * UTIL x-modem *//* UTIL crc16 */static unsigned short util_crc16(unsigned char *ptr, int len) {    unsigned short crc, i;    crc = 0x0000;    while (len--) {        crc ^= (unsigned short) *ptr++ << 8;        for (i = 0; i < 8; i++)            if (crc & 0x8000)                crc = (crc << 1) ^ 0x1021;            else                crc <<= 1;    }    return crc;}/* UTIL x-modem reciever */int util_xmod_recv(void * ptr) {    unsigned char *ptr_w = ptr;    unsigned char *ptr_fix;    unsigned char c, blk = 1;    unsigned short crc, rcrc;    unsigned i, n = 0;    int err, fail;        for (;;) {        err = 0;        fail = 0;        do {            c = dbgu_getc();            if (c != XM_SOH) {                if (c == XM_EOT) {                    dbgu_putc(XM_ACK);                    AT91C_BASE_PIOB->PIO_CODR |= AT91C_PIO_PB27;                    return (128 * n);                }                fail = 1;                break;            }            c = dbgu_getc();            if (c != blk)                fail = 1;            c = dbgu_getc();            if (c != (0xff - blk))                fail = 1;            ptr_fix = ptr_w;            for (i = 0; i < 128; ++i)                *ptr_w++ = dbgu_getc();            c = dbgu_getc();            rcrc = (unsigned short) c << 8;            c = dbgu_getc();            rcrc |= (unsigned short) c;            crc = util_crc16(ptr_fix, 128);            if (crc != rcrc)                fail = 1;            if (fail)                dbgu_putc(XM_NAK);            else {                dbgu_putc(XM_ACK);                break;            }            err += fail;            fail = 0;            if (err > 4) {                return -1;            }        } while (1);        if (!fail) {            ++blk;            ++n;        }    }}